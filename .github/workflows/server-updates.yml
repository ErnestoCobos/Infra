name: Server Updates

on:
  # Scheduled: Monday at 12:00 PM CDMX (18:00 UTC)
  schedule:
    - cron: '0 18 * * 1'

  workflow_dispatch:
    inputs:
      target:
        description: 'Target hosts (group or host)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - sonarqube
      dry_run:
        description: 'Dry run (check only, no apply)'
        required: false
        default: false
        type: boolean

env:
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "false"

jobs:
  update-servers:
    name: Update Servers
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          version: 1.78.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Test Tailscale connectivity
        run: |
          echo "Testing Tailscale connection..."
          tailscale status

      - name: Create logs directory
        run: mkdir -p ansible/logs/updates

      - name: Run updates (dry run)
        if: github.event.inputs.dry_run == 'true' || github.event_name == 'schedule'
        run: |
          cd ansible
          echo "üîç Running in CHECK mode..."
          ansible-playbook playbooks/update.yml \
            --limit "${{ github.event.inputs.target || 'all' }}" \
            --check \
            --diff \
            2>&1 | tee logs/updates/update-output.log

      - name: Run updates (apply)
        if: github.event.inputs.dry_run != 'true' && github.event_name != 'schedule'
        run: |
          cd ansible
          echo "üöÄ Applying updates..."
          ansible-playbook playbooks/update.yml \
            --limit "${{ github.event.inputs.target || 'all' }}" \
            2>&1 | tee logs/updates/update-output.log

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-logs-${{ github.run_number }}
          path: ansible/logs/updates/
          retention-days: 90

      - name: Generate summary
        if: always()
        run: |
          MODE="${{ github.event.inputs.dry_run == 'true' && 'Check' || (github.event_name == 'schedule' && 'Check (Scheduled)' || 'Apply') }}"
          echo "## üîÑ Server Updates - $MODE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ github.event.inputs.target || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "ansible/logs/updates/update-output.log" ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìÑ Ansible Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -150 "ansible/logs/updates/update-output.log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519

  notify:
    name: Send Email Notification
    runs-on: ubuntu-latest
    needs: [update-servers]
    if: always()

    steps:
      - name: Send notification via Resend
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        run: |
          if [ -z "${RESEND_API_KEY}" ]; then
            echo "Resend is not configured (RESEND_API_KEY missing); skipping email."
            exit 0
          fi

          STATUS="${{ needs.update-servers.result }}"
          TARGET="${{ github.event.inputs.target || 'all' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          TRIGGER="${{ github.event_name }}"
          LOGS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$TRIGGER" = "schedule" ]; then
            MODE="Scheduled Check"
          elif [ "$DRY_RUN" = "true" ]; then
            MODE="Dry Run"
          else
            MODE="Apply"
          fi

          if [ "$STATUS" = "success" ]; then
            SUBJECT="‚úÖ Server Updates - $MODE Completed"
            COLOR="#10b981"
            BG_COLOR="#f0fdf4"
            ICON="‚úÖ"
            MESSAGE="Server updates workflow completed successfully."
          else
            SUBJECT="‚ùå Server Updates - $MODE Failed"
            COLOR="#dc2626"
            BG_COLOR="#fef2f2"
            ICON="‚ùå"
            MESSAGE="Server updates workflow failed. Please check the logs."
          fi

          BODY="<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">
            <div style=\"background: ${COLOR}; color: white; padding: 20px; text-align: center;\">
              <h1>${ICON} Server Updates</h1>
            </div>
            <div style=\"padding: 20px; background: ${BG_COLOR}; border: 2px solid ${COLOR};\">
              <p>${MESSAGE}</p>
              <ul>
                <li><strong>Status:</strong> ${STATUS}</li>
                <li><strong>Mode:</strong> ${MODE}</li>
                <li><strong>Target:</strong> ${TARGET}</li>
                <li><strong>Trigger:</strong> ${TRIGGER}</li>
              </ul>
              <p><a href=\"${LOGS_URL}\" style=\"color: ${COLOR};\">View Logs</a></p>
            </div>
          </div>"

          EMAIL_PAYLOAD=$(jq -n \
            --arg from "$EMAIL_FROM" \
            --arg to_csv "$NOTIFY_EMAIL" \
            --arg subject "$SUBJECT" \
            --arg html "$BODY" \
            '{
              from: $from,
              to: ($to_csv | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length>0))),
              subject: $subject,
              html: $html
            }')

          curl -s -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${RESEND_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_PAYLOAD" || true
