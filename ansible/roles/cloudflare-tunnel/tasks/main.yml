---
- name: Validate tunnel token is provided
  ansible.builtin.fail:
    msg: |
      cloudflare_tunnel_token is required!

      To get a token:
      1. Go to Cloudflare Zero Trust dashboard
      2. Networks > Tunnels > Create a tunnel
      3. Select "Cloudflared" connector
      4. Copy the token from the install command

      Then set: CLOUDFLARE_TUNNEL_TOKEN=<your-token>
  when: cloudflare_tunnel_token | length == 0

- name: Add Cloudflare GPG key
  ansible.builtin.get_url:
    url: https://pkg.cloudflare.com/cloudflare-main.gpg
    dest: /usr/share/keyrings/cloudflare-main.gpg
    mode: '0644'

- name: Add Cloudflare repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared {{ ansible_distribution_release }} main"
    state: present
    filename: cloudflared

- name: Install cloudflared
  ansible.builtin.apt:
    name: cloudflared
    state: present
    update_cache: true

- name: Create cloudflared service directory
  ansible.builtin.file:
    path: /etc/cloudflared
    state: directory
    mode: '0755'

- name: Install cloudflared as a service with token
  ansible.builtin.command:
    cmd: cloudflared service install {{ cloudflare_tunnel_token }}
  args:
    creates: /etc/systemd/system/cloudflared.service
  notify: Restart cloudflared

- name: Ensure cloudflared is enabled and started
  ansible.builtin.systemd:
    name: cloudflared
    state: started
    enabled: true
    daemon_reload: true

- name: Verify tunnel is running
  ansible.builtin.command:
    cmd: cloudflared tunnel info
  register: tunnel_info
  changed_when: false
  failed_when: false

- name: Display tunnel status
  ansible.builtin.debug:
    msg: |
      ============================================
      Cloudflare Tunnel configured!

      Status: {{ 'Running' if tunnel_info.rc == 0 else 'Check configuration' }}

      Next steps:
      1. Go to Cloudflare Zero Trust dashboard
      2. Networks > Tunnels > Select your tunnel
      3. Configure Public Hostname:
         - Subdomain: sonarqube (or your choice)
         - Domain: your-domain.com
         - Service: HTTP://localhost:9000

      Your SonarQube will be available at:
      https://sonarqube.your-domain.com
      ============================================
