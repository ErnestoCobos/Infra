name: Cloudflare Tunnel

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target hosts'
        required: true
        default: 'gateway'
        type: choice
        options:
          - gateway
          - arda
      action:
        description: 'Action to perform'
        required: true
        default: 'install'
        type: choice
        options:
          - install
          - status
          - restart
      dry_run:
        description: 'Dry run (check mode)'
        required: false
        default: false
        type: boolean

env:
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "false"

jobs:
  cloudflare-tunnel:
    name: Cloudflare Tunnel - ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale-authkey: ${{ secrets.TS_AUTHKEY }}
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          run-id: ${{ github.run_id }}
          hostname-prefix: gha-cf-tunnel

      - name: Install Cloudflare Tunnel
        if: github.event.inputs.action == 'install'
        env:
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          cd ansible

          if [ -z "$CLOUDFLARE_TUNNEL_TOKEN" ]; then
            echo "::error::CLOUDFLARE_TUNNEL_TOKEN secret is not set!"
            exit 1
          fi

          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            ARGS="--check --diff"
          fi

          ansible-playbook \
            playbooks/cloudflare-tunnel.yml \
            --limit ${{ github.event.inputs.target }} \
            $ARGS

      - name: Check Tunnel Status
        if: github.event.inputs.action == 'status'
        run: |
          cd ansible
          echo "## Cloudflare Tunnel Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ansible ${{ github.event.inputs.target }} -m shell -a "systemctl status cloudflared --no-pager" -b 2>&1 | tee /tmp/status.txt

          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/status.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Restart Tunnel
        if: github.event.inputs.action == 'restart'
        run: |
          cd ansible
          ansible ${{ github.event.inputs.target }} -m systemd -a "name=cloudflared state=restarted" -b

          echo "## Cloudflare Tunnel Restarted" >> $GITHUB_STEP_SUMMARY
          sleep 5

          ansible ${{ github.event.inputs.target }} -m shell -a "systemctl status cloudflared --no-pager" -b 2>&1 | tee /tmp/status.txt

          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/status.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519
