name: SonarQube Health Check

on:
  # Daily at 1:00 PM CDMX (19:00 UTC)
  schedule:
    - cron: '0 19 * * *'

  workflow_dispatch:

env:
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "false"

jobs:
  health-check:
    name: Check SonarQube Status
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      has_issues: ${{ steps.check.outputs.has_issues }}
      report: ${{ steps.check.outputs.report }}
      action_taken: ${{ steps.check.outputs.action_taken }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          if [ -z "$TS_AUTHKEY" ]; then
            echo "ERROR: TS_AUTHKEY secret is not set!"
            exit 1
          fi
          sudo tailscale up --authkey="$TS_AUTHKEY" --hostname=gha-sonar-${{ github.run_id }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Check if SonarQube is installed and running
        id: initial-check
        run: |
          cd ansible
          mkdir -p logs

          # Quick check via SSH if SonarQube is installed/running
          ansible sonarqube -m shell -a "systemctl is-active sonarqube 2>/dev/null || echo 'not-running'" 2>&1 | tee logs/initial-check.log

          if grep -q "not-running\|inactive\|failed" logs/initial-check.log; then
            echo "needs_repair=true" >> $GITHUB_OUTPUT

            # Check if it's installed at all
            ansible sonarqube -m shell -a "test -d /opt/sonarqube && echo 'installed' || echo 'not-installed'" 2>&1 | tee -a logs/initial-check.log

            if grep -q "not-installed" logs/initial-check.log; then
              echo "needs_install=true" >> $GITHUB_OUTPUT
            else
              echo "needs_install=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "needs_repair=false" >> $GITHUB_OUTPUT
            echo "needs_install=false" >> $GITHUB_OUTPUT
          fi

      - name: Install SonarQube (not installed)
        if: steps.initial-check.outputs.needs_install == 'true'
        run: |
          cd ansible
          echo "SonarQube not installed, running full installation..."
          ansible-playbook playbooks/sonarqube.yml 2>&1 | tee logs/install.log
          echo "action_taken=installed" >> $GITHUB_ENV

      - name: Restart SonarQube (installed but not running)
        if: steps.initial-check.outputs.needs_repair == 'true' && steps.initial-check.outputs.needs_install == 'false'
        run: |
          cd ansible
          echo "SonarQube not running, attempting restart..."
          ansible sonarqube -m systemd -a "name=sonarqube state=restarted" -b 2>&1 | tee logs/restart.log

          # Wait for it to come up
          sleep 60

          # Verify it started
          ansible sonarqube -m shell -a "curl -s http://localhost:9000/api/system/status" 2>&1 | tee -a logs/restart.log
          echo "action_taken=restarted" >> $GITHUB_ENV

      - name: Run SonarQube health check
        id: check
        run: |
          cd ansible
          mkdir -p logs

          # Run check playbook and capture output
          ansible-playbook playbooks/check-sonarqube.yml 2>&1 | tee logs/health-check.log

          # Parse the output for status
          if grep -q "Status: UP" logs/health-check.log && grep -q "Health: GREEN" logs/health-check.log; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

          # Extract key metrics for report
          SONAR_STATUS=$(grep -oP "Status: \K\w+" logs/health-check.log || echo "UNKNOWN")
          SONAR_HEALTH=$(grep -oP "Health: \K\w+" logs/health-check.log || echo "UNKNOWN")
          SONAR_VERSION=$(grep -oP "Version: \K[\d.]+" logs/health-check.log || echo "UNKNOWN")
          DISK_USAGE=$(grep -oP "Disk Usage: \K\S+" logs/health-check.log || echo "UNKNOWN")
          MEMORY_USAGE=$(grep -oP "Memory Usage: \K\S+" logs/health-check.log || echo "UNKNOWN")

          # Check for warnings
          DISK_PERCENT=$(echo "$DISK_USAGE" | tr -d '%')
          if [ "$DISK_PERCENT" -gt 80 ] 2>/dev/null; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

          # Include action taken in report
          ACTION="${action_taken:-none}"

          # Create report
          REPORT="SonarQube: $SONAR_STATUS | Health: $SONAR_HEALTH | Version: $SONAR_VERSION | Disk: $DISK_USAGE | Memory: $MEMORY_USAGE | Action: $ACTION"
          echo "report=$REPORT" >> $GITHUB_OUTPUT
          echo "action_taken=$ACTION" >> $GITHUB_OUTPUT

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-logs-${{ github.run_number }}
          path: ansible/logs/
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "## SonarQube Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Report:** ${{ steps.check.outputs.report }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "ansible/logs/health-check.log" ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Full Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "ansible/logs/health-check.log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519

  notify:
    name: Send Email (Issues or Actions Taken)
    runs-on: ubuntu-latest
    needs: [health-check]
    # Send email if: issues detected, action was taken (install/restart), or workflow failed
    if: |
      needs.health-check.outputs.has_issues == 'true' ||
      needs.health-check.outputs.action_taken != 'none' ||
      failure()

    steps:
      - name: Send notification via Resend
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        run: |
          if [ -z "${RESEND_API_KEY}" ]; then
            echo "Resend is not configured (RESEND_API_KEY missing); skipping email."
            exit 0
          fi

          STATUS="${{ needs.health-check.outputs.status }}"
          REPORT="${{ needs.health-check.outputs.report }}"
          ACTION="${{ needs.health-check.outputs.action_taken }}"
          LOGS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          JOB_STATUS="${{ needs.health-check.result }}"

          if [ "$JOB_STATUS" = "failure" ]; then
            SUBJECT="SonarQube Health Check Failed"
            COLOR="#dc2626"
            BG_COLOR="#fef2f2"
            ICON="&#10060;"
            MESSAGE="The SonarQube health check workflow failed to run."
          elif [ "$ACTION" = "installed" ]; then
            SUBJECT="SonarQube Installed Automatically"
            COLOR="#10b981"
            BG_COLOR="#f0fdf4"
            ICON="&#9989;"
            MESSAGE="SonarQube was not installed and has been automatically installed."
          elif [ "$ACTION" = "restarted" ]; then
            SUBJECT="SonarQube Restarted Automatically"
            COLOR="#3b82f6"
            BG_COLOR="#eff6ff"
            ICON="&#128260;"
            MESSAGE="SonarQube was down and has been automatically restarted."
          elif [ "$STATUS" = "unhealthy" ]; then
            SUBJECT="SonarQube Needs Attention"
            COLOR="#f59e0b"
            BG_COLOR="#fffbeb"
            ICON="&#9888;"
            MESSAGE="SonarQube is reporting issues that need attention."
          else
            SUBJECT="SonarQube Warning"
            COLOR="#f59e0b"
            BG_COLOR="#fffbeb"
            ICON="&#9888;"
            MESSAGE="SonarQube health check detected potential issues."
          fi

          BODY="<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">
            <div style=\"background: ${COLOR}; color: white; padding: 20px; text-align: center;\">
              <h1>${ICON} SonarQube Health Check</h1>
            </div>
            <div style=\"padding: 20px; background: ${BG_COLOR}; border: 2px solid ${COLOR};\">
              <p>${MESSAGE}</p>
              <div style=\"background: white; padding: 15px; border-radius: 5px; margin: 15px 0;\">
                <code style=\"font-size: 14px;\">${REPORT}</code>
              </div>
              <ul>
                <li><strong>Status:</strong> ${STATUS}</li>
                <li><strong>Time:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')</li>
              </ul>
              <p><a href=\"${LOGS_URL}\" style=\"color: ${COLOR}; font-weight: bold;\">View Full Logs</a></p>
            </div>
          </div>"

          EMAIL_PAYLOAD=$(jq -n \
            --arg from "$EMAIL_FROM" \
            --arg to_csv "$NOTIFY_EMAIL" \
            --arg subject "$SUBJECT" \
            --arg html "$BODY" \
            '{
              from: $from,
              to: ($to_csv | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length>0))),
              subject: $subject,
              html: $html
            }')

          curl -s -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${RESEND_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_PAYLOAD"

          echo "Email sent: $SUBJECT"
