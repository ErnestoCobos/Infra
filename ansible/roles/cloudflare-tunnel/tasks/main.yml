---
# Verificar si ya est√° instalado
- name: Check if cloudflared service exists
  ansible.builtin.stat:
    path: /etc/systemd/system/cloudflared.service
  register: cloudflared_service

- name: Skip if already installed
  ansible.builtin.debug:
    msg: "Cloudflared already installed. Skipping."
  when: cloudflared_service.stat.exists

# Solo instalar si no existe
- name: Validate token is provided
  ansible.builtin.fail:
    msg: "cloudflare_tunnel_token is required! Set SONARQUBE_TUNNEL_TOKEN env var."
  when:
    - not cloudflared_service.stat.exists
    - cloudflare_tunnel_token | length == 0

- name: Create keyrings directory
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'
  when: not cloudflared_service.stat.exists

- name: Add Cloudflare GPG key
  ansible.builtin.get_url:
    url: https://pkg.cloudflare.com/cloudflare-public-v2.gpg
    dest: /usr/share/keyrings/cloudflare-public-v2.gpg
    mode: '0644'
  when: not cloudflared_service.stat.exists

- name: Add Cloudflare repository
  ansible.builtin.copy:
    content: "deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main\n"
    dest: /etc/apt/sources.list.d/cloudflared.list
    mode: '0644'
  when: not cloudflared_service.stat.exists

- name: Install cloudflared
  ansible.builtin.apt:
    name: cloudflared
    state: present
    update_cache: true
  when: not cloudflared_service.stat.exists

- name: Install cloudflared service
  ansible.builtin.command:
    cmd: "cloudflared service install {{ cloudflare_tunnel_token }}"
  when: not cloudflared_service.stat.exists

# Verificar estado
- name: Check service status
  ansible.builtin.systemd:
    name: cloudflared
  register: cloudflared_status
  failed_when: false

- name: Display status
  ansible.builtin.debug:
    msg: "Cloudflared: {{ cloudflared_status.status.ActiveState | default('unknown') }}"
