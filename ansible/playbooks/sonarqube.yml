---
- name: Install and Configure SonarQube
  hosts: sonarqube
  become: true

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts['os_family'] == "Debian"

  roles:
    - role: common
      tags: [common]
    - role: sonarqube
      tags: [sonarqube]
    - role: cloudflare-tunnel
      tags: [cloudflare]

  post_tasks:
    - name: Display SonarQube access information
      ansible.builtin.debug:
        msg: |
          ============================================
          SonarQube installed successfully!

          Access URL: http://{{ ansible_host }}:{{ sonarqube_port }}

          Default credentials:
            Username: admin
            Password: admin

          IMPORTANT: Change the default password on first login!
          ============================================
      tags: [always]
