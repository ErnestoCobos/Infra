name: Ansible Deploy

on:
  push:
    branches: [main]
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ansible/**'
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook to run'
        required: true
        default: 'sonarqube.yml'
        type: choice
        options:
          - sonarqube.yml
          - check-sonarqube.yml
          - upgrade-sonarqube.yml
          - gateway.yml
      target:
        description: 'Target hosts (group or host name)'
        required: true
        default: 'sonarqube'
        type: string
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Dry run (check mode)'
        required: false
        default: false
        type: boolean
      sonarqube_version:
        description: 'SonarQube version (only for upgrade-sonarqube.yml)'
        required: false
        default: ''
        type: string

env:
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "false"
  PY_COLORS: "1"

jobs:
  lint:
    name: Lint Ansible
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ansible-lint
        run: pip install ansible-lint

      - name: Run ansible-lint
        run: |
          cd ansible
          ansible-lint playbooks/

  # Dry run en Pull Requests - muestra cambios sin aplicar
  plan:
    name: Plan Changes (Dry Run)
    runs-on: ubuntu-latest
    needs: [lint]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale-authkey: ${{ secrets.TS_AUTHKEY }}
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          run-id: ${{ github.run_id }}
          hostname-prefix: gha-plan

      - name: Run Ansible Playbook (Dry Run)
        id: plan
        env:
          SONARQUBE_DB_PASSWORD: ${{ secrets.SONARQUBE_DB_PASSWORD }}
          SONARQUBE_TUNNEL_TOKEN: ${{ secrets.SONARQUBE_TUNNEL_TOKEN }}
          ANSIBLE_BECOME_PASSWORD: ${{ secrets.ANSIBLE_BECOME_PASSWORD }}
        run: |
          cd ansible
          echo "## üìã Ansible Plan - Changes to be applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          ansible-playbook \
            playbooks/sonarqube.yml \
            --check \
            --diff 2>&1 | tee /tmp/ansible-output.txt || true
          cat /tmp/ansible-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with plan
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/ansible-output.txt', 'utf8');

            // Truncate if too long
            const maxLength = 60000;
            const truncated = output.length > maxLength
              ? output.substring(0, maxLength) + '\n... (truncated)'
              : output;

            const body = `## üîç Ansible Dry Run Results

            This is a preview of changes that will be applied when this PR is merged.

            <details>
            <summary>üìã Click to see Ansible output</summary>

            \`\`\`diff
            ${truncated}
            \`\`\`

            </details>

            > ‚ö†Ô∏è **No changes have been applied.** This is a dry run only.
            > Changes will be applied automatically when merged to main.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519

  # Deploy real en push a main o manual
  deploy:
    name: Deploy with Ansible
    runs-on: ubuntu-latest
    needs: [lint]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale-authkey: ${{ secrets.TS_AUTHKEY }}
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          run-id: ${{ github.run_id }}
          hostname-prefix: gha-deploy

      - name: Run Ansible Playbook (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          SONARQUBE_DB_PASSWORD: ${{ secrets.SONARQUBE_DB_PASSWORD }}
          SONARQUBE_TUNNEL_TOKEN: ${{ secrets.SONARQUBE_TUNNEL_TOKEN }}
          ANSIBLE_BECOME_PASSWORD: ${{ secrets.ANSIBLE_BECOME_PASSWORD }}
        run: |
          cd ansible
          EXTRA_VARS=""
          if [[ "${{ github.event.inputs.playbook }}" == "upgrade-sonarqube.yml" && -n "${{ github.event.inputs.sonarqube_version }}" ]]; then
            EXTRA_VARS="-e new_version=${{ github.event.inputs.sonarqube_version }}"
          fi
          ansible-playbook \
            playbooks/${{ github.event.inputs.playbook || 'sonarqube.yml' }} \
            --limit ${{ github.event.inputs.target || 'sonarqube' }} \
            --check \
            --diff \
            $EXTRA_VARS

      - name: Run Ansible Playbook
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          SONARQUBE_DB_PASSWORD: ${{ secrets.SONARQUBE_DB_PASSWORD }}
          SONARQUBE_TUNNEL_TOKEN: ${{ secrets.SONARQUBE_TUNNEL_TOKEN }}
          ANSIBLE_BECOME_PASSWORD: ${{ secrets.ANSIBLE_BECOME_PASSWORD }}
        run: |
          cd ansible
          EXTRA_VARS=""
          if [[ "${{ github.event.inputs.playbook }}" == "upgrade-sonarqube.yml" && -n "${{ github.event.inputs.sonarqube_version }}" ]]; then
            EXTRA_VARS="-e new_version=${{ github.event.inputs.sonarqube_version }}"
          fi
          ansible-playbook \
            playbooks/${{ github.event.inputs.playbook || 'sonarqube.yml' }} \
            --limit ${{ github.event.inputs.target || 'sonarqube' }} \
            $EXTRA_VARS

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519
