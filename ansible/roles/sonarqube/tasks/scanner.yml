---
- name: Check if SonarScanner is already installed
  ansible.builtin.stat:
    path: /opt/sonarscanner
  register: sonarscanner_installed

- name: Download SonarScanner CLI
  ansible.builtin.get_url:
    url: "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-{{ sonarscanner_version }}-linux-x64.zip"
    dest: /tmp/sonar-scanner-cli-{{ sonarscanner_version }}.zip
    mode: '0644'
  when: not sonarscanner_installed.stat.exists

- name: Extract SonarScanner
  ansible.builtin.unarchive:
    src: /tmp/sonar-scanner-cli-{{ sonarscanner_version }}.zip
    dest: /tmp
    remote_src: true
  when: not sonarscanner_installed.stat.exists

- name: Move SonarScanner to /opt
  ansible.builtin.command:
    cmd: mv /tmp/sonar-scanner-{{ sonarscanner_version }}-linux-x64 /opt/sonarscanner
    creates: /opt/sonarscanner
  when: not sonarscanner_installed.stat.exists

- name: Configure SonarScanner
  ansible.builtin.lineinfile:
    path: /opt/sonarscanner/conf/sonar-scanner.properties
    regexp: '^#?sonar.host.url='
    line: "sonar.host.url=http://127.0.0.1:{{ sonarqube_port }}"
    state: present

- name: Make sonar-scanner executable
  ansible.builtin.file:
    path: /opt/sonarscanner/bin/sonar-scanner
    mode: '0755'

- name: Create symlink for sonar-scanner
  ansible.builtin.file:
    src: /opt/sonarscanner/bin/sonar-scanner
    dest: /usr/local/bin/sonar-scanner
    state: link

- name: Clean up downloaded archive
  ansible.builtin.file:
    path: /tmp/sonar-scanner-cli-{{ sonarscanner_version }}.zip
    state: absent
