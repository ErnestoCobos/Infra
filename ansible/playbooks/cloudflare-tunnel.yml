---
- name: Configure Cloudflare Tunnel for SonarQube
  hosts: sonarqube
  become: true

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts['os_family'] == "Debian"

  roles:
    - role: cloudflare-tunnel
      tags: [cloudflare, tunnel]

  post_tasks:
    - name: Display access information
      ansible.builtin.debug:
        msg: |
          ============================================
          Cloudflare Tunnel Setup Complete!

          The tunnel is now running and connected to Cloudflare.

          To expose SonarQube:
          1. Go to: https://one.dash.cloudflare.com/
          2. Select your account > Networks > Tunnels
          3. Click on your tunnel > Public Hostname
          4. Add a public hostname:
             - Subdomain: sonarqube
             - Domain: (select your domain)
             - Type: HTTP
             - URL: localhost:9000

          Optional - Add Cloudflare Access policy:
          1. Access > Applications > Add an application
          2. Self-hosted > Configure
          3. Add authentication (Google, GitHub, email OTP, etc.)

          This adds an extra layer of auth before reaching SonarQube!
          ============================================
      tags: [always]
